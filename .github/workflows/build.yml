name: ci

on: push

env:
  mold_version: "1.2.0"

jobs:

  test_deb:
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        container_image:
          [
            "ubuntu:20.04",
            "debian:11",
          ]
    container:
      image: ${{ matrix.container_image }}
    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Download from github release
      run: |
        export DEBIAN_FRONTEND=noninteractive
        apt-get update && apt-get install -y wget tar curl strace
        curl -fsSL https://raw.githubusercontent.com/ren15/mold_ci/HEAD/install.sh | bash
        strace -e trace=open,close -o strace_output.txt -y mold --version
        bash scripts/regex_extract.sh strace_output.txt
        ls package
        tar cvf lib-package.tar.gz package

    - uses: actions/upload-artifact@v2
      with:
        name: lib-package
        path: lib-package.tar.gz

  test_rpm:
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        container_image:
          [
            "fedora:35",
          ]
    container:
      image: ${{ matrix.container_image }}
    steps:
    - name: Download from github release
      run: |
        yum install -y tar wget openssl-devel curl
        curl -fsSL https://raw.githubusercontent.com/ren15/mold_ci/HEAD/install.sh | bash
        mold --version

  test_centos7:
    runs-on: ubuntu-20.04
    needs: ["test_deb"]
    strategy:
      fail-fast: false
      matrix:
        container_image:
          [
            "centos:7",
            "rockylinux:8",
          ]
    container:
      image: ${{ matrix.container_image }}

    steps:
    - uses: actions/download-artifact@v2
      with:
        name: lib-package
    - name: Download from github release
      run: |
        yum install -y tar wget openssl-devel curl
        curl -fsSL https://raw.githubusercontent.com/ren15/mold_ci/HEAD/install.sh | bash
        ls 
        tar xvf lib-package.tar.gz
        ls package
        package/ld-linux-x86-64.so.2 --library-path ${PWD}/package mold --version